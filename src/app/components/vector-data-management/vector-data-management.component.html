<!-- vector-data-management.component.html -->
<div class="card">
  <p-tabs p-tabs value="0">
    <p-tablist>
      <p-tab value="0">Create</p-tab>
      <p-tab value="1">Upload</p-tab>
      <p-tab value="2">Manage</p-tab>
      <p-tab value="3">Attributes</p-tab>
    </p-tablist>

    <p-tabpanels>
      <!-- Create Tab -->
      <p-tabpanel value="0">
        <div class="grid p-fluid">

          <div class="col-12 md:col-4">
            <button pButton label="Point" icon="pi pi-circle" class="w-full mb-2" (click)="startDrawing('point')"
              [disabled]="isDrawing"></button>
          </div>

          <div class="col-12 md:col-4">
            <button pButton label="Line" icon="pi pi-minus" class="w-full mb-2" (click)="startDrawing('line')"
              [disabled]="isDrawing"></button>
          </div>
          <div class="col-12 md:col-4">
            <button pButton label="Polygon" icon="pi pi-stop" class="w-full mb-2" (click)="startDrawing('polygon')"
              [disabled]="isDrawing"></button>
          </div>
          <!-- MultiPoint -->
          <div class="col-12 md:col-4">
            <button pButton [label]="isDrawing && drawingType === 'multiPoint' ? 'Stop MultiPoint' : 'Draw MultiPoint'"
              [icon]="isDrawing && drawingType === 'multiPoint' ? 'pi pi-stop' : 'pi pi-circle'" class="w-full mb-2"
              [disabled]="isDrawing && drawingType !== 'multiPoint'" (click)="toggleDrawing('multiPoint')">
            </button>
          </div>

          <!-- MultiLine -->
          <div class="col-12 md:col-4">
            <button pButton [label]="isDrawing && drawingType === 'multiLine' ? 'Stop MultiLine' : 'Draw MultiLine'"
              [icon]="isDrawing && drawingType === 'multiLine' ? 'pi pi-stop' : 'pi pi-minus'" class="w-full mb-2"
              [disabled]="isDrawing && drawingType !== 'multiLine'" (click)="toggleDrawing('multiLine')">
            </button>
          </div>

          <!-- MultiPolygon -->
          <div class="col-12 md:col-4">
            <button pButton
              [label]="isDrawing && drawingType === 'multiPolygon' ? 'Stop MultiPolygon' : 'Draw MultiPolygon'"
              [icon]="isDrawing && drawingType === 'multiPolygon' ? 'pi pi-stop' : 'pi pi-stop'" class="w-full mb-2"
              [disabled]="isDrawing && drawingType !== 'multiPolygon'" (click)="toggleDrawing('multiPolygon')">
            </button>
          </div>

          <div class="col-12 md:col-4">
            <button pButton label="Circle" icon="pi pi-circle-on" class="w-full mb-2" (click)="startDrawing('circle')"
              [disabled]="isDrawing"></button>
          </div>
          <div class="col-12 md:col-4">
            <button pButton label="Rectangle" icon="pi pi-square" class="w-full mb-2"
              (click)="startDrawing('rectangle')" [disabled]="isDrawing"></button>
          </div>
          <div class="col-12" *ngIf="isDrawing">
            <p-card header="Drawing Mode Active">
              <p>Drawing a {{drawingType}}. Click on the map to create vertices.</p>
              <p>Double-click to finish drawing.</p>
              <button pButton label="Cancel Drawing" icon="pi pi-times" class="p-button-danger"
                (click)="cancelDrawing()"></button>
            </p-card>
          </div>
        </div>
      </p-tabpanel>

      <!-- Upload Tab -->
      <p-tabpanel value="1">
        <div class="grid p-fluid">
          <div class="col-12">
            <p-fileUpload name="vectorData" [accept]="acceptedFileTypes" [maxFileSize]="10000000" [customUpload]="true"
              (uploadHandler)="onFileUpload($event)" chooseLabel="Browse" uploadLabel="Import" cancelLabel="Cancel">
              <ng-template pTemplate="content">
                <ul *ngIf="uploadedFiles.length">
                  <li *ngFor="let file of uploadedFiles">
                    {{ file.name }} - {{ file.size }} bytes
                  </li>
                </ul>
              </ng-template>
            </p-fileUpload>
            <small>Supported formats: SHP (zipped), KML, GPX, GeoJSON</small>

            <!-- Progress bar for shapefile upload -->
            <div class="mt-3" *ngIf="isUploading">
              <p>Uploading and processing shapefile...</p>
              <p-progressBar [value]="uploadProgress" [showValue]="true"></p-progressBar>
            </div>
          </div>
        </div>
      </p-tabpanel>

      <!-- Manage Tab -->
      <p-tabpanel value="2">
        <div class="grid p-fluid">
          <div class="col-12 md:col-6">
            <button pButton label="Toggle Edit Mode" icon="pi pi-pencil" class="w-full mb-2"
              (click)="toggleEditMode()"></button>
          </div>
          <div class="col-12 md:col-6">
            <button pButton label="Delete Selected" icon="pi pi-trash" class="p-button-danger w-full mb-2"
              (click)="deleteSelectedFeature()" [disabled]="!selectedFeature"></button>
          </div>

          <div class="col-12 md:col-4">
            <button pButton label="Export GeoJSON" icon="pi pi-download" class="p-button-help w-full mb-2"
              (click)="exportData('geojson')"></button>
          </div>
          <div class="col-12 md:col-4">
            <button pButton label="Export KML" icon="pi pi-download" class="p-button-help w-full mb-2"
              (click)="exportData('kml')"></button>
          </div>
          <div class="col-12 md:col-4">
            <button pButton label="Export GPX" icon="pi pi-download" class="p-button-help w-full mb-2"
              (click)="exportData('gpx')"></button>
          </div>

          <div class="col-12">
            <button pButton label="Clear All Data" icon="pi pi-times" class="p-button-warning w-full"
              (click)="clearAllData()"></button>
          </div>

          <div class="col-12" *ngIf="selectedFeature">
            <p-card header="Selected Feature">
              <p>Type: {{ selectedFeature.getGeometry()?.getType() }}</p>
              <div *ngFor="let key of getFeaturePropertyKeys(selectedFeature)">
                <strong>{{ key }}:</strong> {{ selectedFeature.get(key) }}
              </div>
              <button pButton label="Edit Attributes" icon="pi pi-cog" class="w-full mt-2"
                (click)="openAttributeDialog()"></button>
            </p-card>
          </div>
        </div>
      </p-tabpanel>

      <!-- Attributes Tab - NEW: For managing attribute templates -->
      <p-tabpanel value="3">
        <div class="grid p-fluid">
          <div class="col-12">
            <p-card header="Attribute Templates">
              <p>Define attribute templates that will be available for new features.</p>

              <div class="mb-4" *ngFor="let field of attributeTemplates; let i = index">
                <div class="grid">
                  <div class="col-12 md:col-4">
                    <label>Field Name</label>
                    <input pInputText [(ngModel)]="field.name" placeholder="e.g., name, type, elevation"
                      class="w-full" />
                  </div>
                  <div class="col-12 md:col-4">
                    <label>Display Label</label>
                    <input pInputText [(ngModel)]="field.label" placeholder="e.g., Name, Type, Elevation"
                      class="w-full" />
                  </div>
                  <div class="col-12 md:col-3">
                    <label>Data Type</label>
                    <p-select [options]="dataTypes" [(ngModel)]="field.type" optionLabel="label" optionValue="value"
                      class="w-full"></p-select>
                  </div>
                  <div class="col-12 md:col-1 flex align-items-center">
                    <button pButton icon="pi pi-trash" class="p-button-danger"
                      (click)="removeAttributeTemplate(i)"></button>
                  </div>
                </div>
              </div>

              <button pButton label="Add Field" icon="pi pi-plus" class="mr-2"
                (click)="addAttributeTemplate()"></button>
              <button pButton label="Save Templates" icon="pi pi-save" (click)="saveAttributeTemplates()"></button>
            </p-card>
          </div>
        </div>
      </p-tabpanel>
    </p-tabpanels>
  </p-tabs>

  <!-- Attribute Dialog - UPDATED: Now dynamic -->
  <p-dialog header="Edit Attributes" [(visible)]="displayAttributeDialog" [modal]="true" [style]="{width: '50vw'}">
    <div class="grid p-fluid" *ngIf="selectedFeature">
      <!-- Show all existing properties except geometry and style -->
      <div class="col-12" *ngFor="let key of getFeaturePropertyKeys(selectedFeature)">
        <label [for]="key">{{ key }}</label>
        <input pInputText [id]="key" [(ngModel)]="attributeData[key]" class="w-full" />
      </div>

      <!-- Add new attributes -->
      <div class="col-12 mt-3">
        <p-divider></p-divider>
        <h4>Add New Attributes</h4>

        <div class="grid">
          <div class="col-12 md:col-6">
            <input pInputText [(ngModel)]="newAttributeName" placeholder="Attribute name" class="w-full mb-2" />
          </div>
          <div class="col-12 md:col-6">
            <input pInputText [(ngModel)]="newAttributeValue" placeholder="Attribute value" class="w-full mb-2" />
          </div>
          <div class="col-12">
            <button pButton label="Add Attribute" icon="pi pi-plus" (click)="addNewAttribute()"></button>
          </div>
        </div>
      </div>
    </div>
    <ng-template pTemplate="footer">
      <button pButton label="Cancel" icon="pi pi-times" class="p-button-text"
        (click)="displayAttributeDialog = false"></button>
      <button pButton label="Save" icon="pi pi-check" (click)="saveAttributes()"></button>
    </ng-template>
  </p-dialog>
</div>

<p-toast></p-toast>